{% extends "base.html" %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">èˆ†æƒ…ç›‘æµ‹ä»ªè¡¨ç›˜</h1>
    <p class="page-subtitle">å®æ—¶ç›‘æ§å“ç‰Œå£°é‡ï¼Œæ´å¯Ÿèˆ†è®ºè¶‹åŠ¿</p>
</div>

<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-value" id="total-articles">--</div>
        <div class="stat-label">ä»Šæ—¥é‡‡é›†æ–‡ç« </div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="positive-count" style="color: var(--success);">--</div>
        <div class="stat-label">ç§¯æå†…å®¹</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="negative-count" style="color: var(--danger);">--</div>
        <div class="stat-label">æ¶ˆæå†…å®¹</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="platforms-count">--</div>
        <div class="stat-label">ç›‘æµ‹å¹³å°</div>
    </div>
</div>

<div class="card">
    <div class="card-title">ğŸ“Š é…ç½®çŠ¶æ€</div>
    <div id="config-status">
        <div class="spinner"></div>
        <span style="margin-left: 12px; color: var(--text-secondary);">åŠ è½½ä¸­...</span>
    </div>
</div>

<div class="card">
    <div class="card-title">ğŸ“± å¹³å°ç™»å½•çŠ¶æ€</div>
    <div id="platforms-status">
        <div class="spinner"></div>
        <span style="margin-left: 12px; color: var(--text-secondary);">åŠ è½½ä¸­...</span>
    </div>
</div>

<div class="card">
    <div class="card-title">ğŸ“‹ æœ€è¿‘é‡‡é›†ç»“æœ</div>
    <div id="latest-crawl">
        <p style="color: var(--text-secondary);">æš‚æ— é‡‡é›†è®°å½•ï¼Œè¯·å‰å¾€<a href="/tasks" style="color: var(--accent);">é‡‡é›†ä»»åŠ¡</a>é¡µé¢å¯åŠ¨é‡‡é›†ã€‚</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function loadConfigStatus() {
    try {
        const response = await fetch('/api/config/validate');
        const data = await response.json();
        
        const container = document.getElementById('config-status');
        container.innerHTML = `
            <div style="display: flex; flex-direction: column; gap: 12px;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span class="badge ${data.feishu ? 'badge-success' : 'badge-danger'}">
                        ${data.feishu ? 'âœ“' : 'âœ—'} é£ä¹¦
                    </span>
                    <span style="color: var(--text-secondary); font-size: 13px;">
                        ${data.details.feishu}
                    </span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span class="badge ${data.llm ? 'badge-success' : 'badge-danger'}">
                        ${data.llm ? 'âœ“' : 'âœ—'} LLM
                    </span>
                    <span style="color: var(--text-secondary); font-size: 13px;">
                        ${data.details.llm}
                    </span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span class="badge ${data.keywords ? 'badge-success' : 'badge-danger'}">
                        ${data.keywords ? 'âœ“' : 'âœ—'} å…³é”®è¯
                    </span>
                    <span style="color: var(--text-secondary); font-size: 13px;">
                        ${data.details.keywords}
                    </span>
                </div>
            </div>
        `;
        
        document.getElementById('platforms-count').textContent = '2';
        
    } catch (error) {
        console.error('åŠ è½½é…ç½®çŠ¶æ€å¤±è´¥:', error);
    }
}

async function loadPlatformsStatus() {
    try {
        const response = await fetch('/api/auth/platforms');
        const data = await response.json();
        
        const container = document.getElementById('platforms-status');
        const platformNames = {
            'xhs': 'å°çº¢ä¹¦',
            'wechat_mp': 'å¾®ä¿¡å…¬ä¼—å·'
        };
        
        container.innerHTML = data.map(p => `
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                <span class="badge ${p.logged_in ? 'badge-success' : 'badge-warning'}">
                    ${p.logged_in ? 'å·²ç™»å½•' : 'æœªç™»å½•'}
                </span>
                <span>${platformNames[p.platform] || p.platform}</span>
                ${p.last_login ? `
                    <span style="color: var(--text-secondary); font-size: 12px;">
                        ä¸Šæ¬¡ç™»å½•: ${new Date(p.last_login).toLocaleString()}
                    </span>
                ` : ''}
            </div>
        `).join('');
        
    } catch (error) {
        console.error('åŠ è½½å¹³å°çŠ¶æ€å¤±è´¥:', error);
    }
}

async function loadLatestCrawl() {
    try {
        const response = await fetch('/api/crawl/latest');
        const data = await response.json();
        
        const container = document.getElementById('latest-crawl');
        
        if (!data || data.total === 0) {
            container.innerHTML = `<p style="color: var(--text-secondary);">æš‚æ— é‡‡é›†è®°å½•ï¼Œè¯·å‰å¾€<a href="/tasks" style="color: var(--accent);">é‡‡é›†ä»»åŠ¡</a>é¡µé¢å¯åŠ¨é‡‡é›†ã€‚</p>`;
            return;
        }
        
        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        document.getElementById('total-articles').textContent = data.total;
        document.getElementById('positive-count').textContent = data.sentiment_stats?.['ç§¯æ'] || 0;
        document.getElementById('negative-count').textContent = data.sentiment_stats?.['æ¶ˆæ'] || 0;
        
        // æ˜¾ç¤ºæœ€è¿‘é‡‡é›†æ‘˜è¦
        const timeStr = data.crawled_at ? new Date(data.crawled_at).toLocaleString('zh-CN') : 'æœªçŸ¥';
        container.innerHTML = `
            <div style="margin-bottom: 16px;">
                <span style="color: var(--text-secondary);">é‡‡é›†æ—¶é—´ï¼š${timeStr}</span>
                <span style="margin-left: 16px; color: var(--text-secondary);">å…± ${data.total} ç¯‡æ–‡ç« </span>
            </div>
            ${data.articles && data.articles.length > 0 ? `
                <table class="table">
                    <thead>
                        <tr>
                            <th>æ ‡é¢˜</th>
                            <th>æ¥æº</th>
                            <th>æƒ…æ„Ÿ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.articles.slice(0, 5).map(a => `
                            <tr>
                                <td><a href="${a.url}" target="_blank" style="color: var(--accent);">${(a.title || '').substring(0, 40)}${a.title && a.title.length > 40 ? '...' : ''}</a></td>
                                <td>${a.author || a.platform || '-'}</td>
                                <td><span class="badge ${a.sentiment === 'ç§¯æ' ? 'badge-success' : a.sentiment === 'æ¶ˆæ' ? 'badge-danger' : 'badge-warning'}">${a.sentiment || 'æœªåˆ†æ'}</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                <div style="margin-top: 12px;">
                    <a href="/tasks" style="color: var(--accent);">æŸ¥çœ‹å…¨éƒ¨ â†’</a>
                </div>
            ` : ''}
        `;
        
    } catch (error) {
        console.error('åŠ è½½æœ€è¿‘é‡‡é›†ç»“æœå¤±è´¥:', error);
    }
}

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    loadConfigStatus();
    loadPlatformsStatus();
    loadLatestCrawl();
});
</script>
{% endblock %}


