{% extends "base.html" %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">é‡‡é›†ä¸æ—¥æŠ¥</h1>
    <p class="page-subtitle">å¯åŠ¨é‡‡é›†ä»»åŠ¡ã€æŸ¥çœ‹ç»“æœã€ç”Ÿæˆèˆ†æƒ…ç®€æŠ¥</p>
</div>

<div id="alert-container"></div>

<!-- å¯åŠ¨ä»»åŠ¡ -->
<div class="card">
    <div class="card-title">ğŸš€ å¯åŠ¨æ–°ä»»åŠ¡</div>
    <form id="start-task-form">
        <div class="form-group">
            <label class="form-label">é€‰æ‹©å¹³å°</label>
            <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" name="platforms" value="wechat" checked>
                    å¾®ä¿¡å…¬ä¼—å·
                </label>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" name="platforms" value="xhs">
                    å°çº¢ä¹¦
                </label>
            </div>
        </div>
        <div class="form-group">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="checkbox" id="filter_enabled" checked>
                å¯ç”¨å…³é”®è¯è¿‡æ»¤
            </label>
        </div>
        <div class="form-group">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="checkbox" id="analyze_sentiment" checked>
                è¿›è¡Œæƒ…æ„Ÿåˆ†æ
            </label>
        </div>
        <div class="form-group">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="checkbox" id="save_to_feishu" checked>
                ä¿å­˜åˆ°é£ä¹¦
            </label>
        </div>
        <div class="form-group">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="checkbox" id="generate_briefing">
                ç”ŸæˆAIç®€æŠ¥å¹¶æ¨é€
            </label>
        </div>
        <button type="submit" class="btn btn-primary" id="start-btn">
            ğŸš€ å¯åŠ¨é‡‡é›†
        </button>
    </form>
</div>

<!-- å½“å‰ä»»åŠ¡ -->
<div class="card" id="current-task-card" style="display: none;">
    <div class="card-title">ğŸ“‹ å½“å‰ä»»åŠ¡</div>
    <div id="current-task">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
            <span id="task-status" class="badge badge-warning">è¿›è¡Œä¸­</span>
            <span id="task-message" style="color: var(--text-secondary);"></span>
        </div>
        <div class="progress" style="margin-bottom: 8px;">
            <div class="progress-bar" id="task-progress" style="width: 0%;"></div>
        </div>
        <span id="task-progress-text" style="color: var(--text-secondary); font-size: 13px;">0%</span>
    </div>
</div>

<!-- ä»»åŠ¡ç»“æœ -->
<div class="card" id="task-result-card" style="display: none;">
    <div class="card-title">ğŸ“Š ä»»åŠ¡ç»“æœ</div>
    <div id="task-result"></div>
    
    <!-- æ—¥æŠ¥ç”ŸæˆåŒºåŸŸ -->
    <div id="report-actions" style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border);">
        <div class="card-title">ğŸ“ˆ èˆ†æƒ…æ—¥æŠ¥</div>
        <div style="display: flex; gap: 12px; margin-bottom: 16px;">
            <button class="btn btn-primary" onclick="generateAIBriefing()" id="gen-briefing-btn">
                ğŸ¤– ç”ŸæˆAIæ™ºèƒ½ç®€æŠ¥
            </button>
            <button class="btn btn-secondary" onclick="sendToFeishu()" id="send-feishu-btn">
                ğŸ“¤ å‘é€åˆ°é£ä¹¦
            </button>
        </div>
        <div id="briefing-container" style="display: none;">
            <div style="padding: 16px; background: var(--bg-secondary); border-radius: 8px; white-space: pre-wrap; font-size: 14px; line-height: 1.8;">
                <div id="briefing-content"></div>
            </div>
            <div style="margin-top: 12px;">
                <button class="btn btn-secondary" onclick="copyBriefing()">ğŸ“‹ å¤åˆ¶ç®€æŠ¥</button>
            </div>
        </div>
    </div>
</div>

<!-- å†å²ä»»åŠ¡ -->
<div class="card">
    <div class="card-title">ğŸ“œ å†å²ä»»åŠ¡</div>
    <div id="tasks-list">
        <p style="color: var(--text-secondary);">æš‚æ— å†å²ä»»åŠ¡</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentTaskId = null;
let pollInterval = null;

function showAlert(message, type = 'success') {
    const container = document.getElementById('alert-container');
    container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
    setTimeout(() => container.innerHTML = '', 5000);
}

// å¯åŠ¨ä»»åŠ¡
document.getElementById('start-task-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const platforms = Array.from(document.querySelectorAll('input[name="platforms"]:checked'))
        .map(cb => cb.value);
    
    if (platforms.length === 0) {
        showAlert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªå¹³å°', 'error');
        return;
    }
    
    const data = {
        platforms: platforms,
        filter_enabled: document.getElementById('filter_enabled').checked,
        analyze_sentiment: document.getElementById('analyze_sentiment').checked,
        save_to_feishu: document.getElementById('save_to_feishu').checked,
        generate_briefing: document.getElementById('generate_briefing').checked,
    };
    
    const startBtn = document.getElementById('start-btn');
    startBtn.disabled = true;
    startBtn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></div> å¯åŠ¨ä¸­...';
    
    try {
        const response = await fetch('/api/crawl/start', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        const task = await response.json();
        currentTaskId = task.task_id;
        
        document.getElementById('current-task-card').style.display = 'block';
        document.getElementById('task-result-card').style.display = 'none';
        
        // å¼€å§‹è½®è¯¢ä»»åŠ¡çŠ¶æ€
        pollInterval = setInterval(pollTaskStatus, 2000);
        
    } catch (error) {
        showAlert('å¯åŠ¨å¤±è´¥: ' + error.message, 'error');
        startBtn.disabled = false;
        startBtn.innerHTML = 'ğŸš€ å¯åŠ¨é‡‡é›†';
    }
});

// è½®è¯¢ä»»åŠ¡çŠ¶æ€
async function pollTaskStatus() {
    if (!currentTaskId) return;
    
    try {
        const response = await fetch(`/api/crawl/status/${currentTaskId}`);
        const task = await response.json();
        
        // æ›´æ–°UI
        document.getElementById('task-message').textContent = task.message;
        document.getElementById('task-progress').style.width = task.progress + '%';
        document.getElementById('task-progress-text').textContent = task.progress + '%';
        
        if (task.status === 'completed') {
            clearInterval(pollInterval);
            document.getElementById('task-status').textContent = 'å·²å®Œæˆ';
            document.getElementById('task-status').className = 'badge badge-success';
            
            // æ˜¾ç¤ºç»“æœ
            showTaskResult(task.result);
            
            // æ¢å¤æŒ‰é’®
            const startBtn = document.getElementById('start-btn');
            startBtn.disabled = false;
            startBtn.innerHTML = 'ğŸš€ å¯åŠ¨é‡‡é›†';
            
            // åˆ·æ–°å†å²ä»»åŠ¡
            loadTasks();
            
        } else if (task.status === 'failed') {
            clearInterval(pollInterval);
            document.getElementById('task-status').textContent = 'å¤±è´¥';
            document.getElementById('task-status').className = 'badge badge-danger';
            
            showAlert('ä»»åŠ¡å¤±è´¥: ' + task.message, 'error');
            
            const startBtn = document.getElementById('start-btn');
            startBtn.disabled = false;
            startBtn.innerHTML = 'ğŸš€ å¯åŠ¨é‡‡é›†';
        }
        
    } catch (error) {
        console.error('è·å–ä»»åŠ¡çŠ¶æ€å¤±è´¥:', error);
    }
}

// æ˜¾ç¤ºä»»åŠ¡ç»“æœ
function showTaskResult(result) {
    if (!result) return;
    
    const container = document.getElementById('task-result');
    document.getElementById('task-result-card').style.display = 'block';
    
    container.innerHTML = `
        <div class="stats-grid" style="margin-bottom: 20px;">
            <div class="stat-card">
                <div class="stat-value">${result.total_articles}</div>
                <div class="stat-label">é‡‡é›†æ–‡ç« æ€»æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" style="color: var(--success);">${result.sentiment_stats['ç§¯æ'] || 0}</div>
                <div class="stat-label">ç§¯æ</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" style="color: var(--danger);">${result.sentiment_stats['æ¶ˆæ'] || 0}</div>
                <div class="stat-label">æ¶ˆæ</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${result.sentiment_stats['ä¸­ç«‹'] || 0}</div>
                <div class="stat-label">ä¸­ç«‹</div>
            </div>
        </div>
        
        ${result.feishu_result ? `
            <div style="margin-bottom: 16px; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                <strong>é£ä¹¦å­˜å‚¨:</strong> 
                æˆåŠŸ ${result.feishu_result.success}, 
                å¤±è´¥ ${result.feishu_result.failed}, 
                è·³è¿‡ ${result.feishu_result.skipped}
            </div>
        ` : ''}
        
        ${result.briefing ? `
            <div style="margin-bottom: 16px;">
                <strong>AIç®€æŠ¥é¢„è§ˆ:</strong>
                <div style="margin-top: 8px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; white-space: pre-wrap; font-size: 13px;">
                    ${result.briefing}
                </div>
            </div>
        ` : ''}
        
        <div>
            <strong>æ–‡ç« é¢„è§ˆ (å‰10ç¯‡):</strong>
            <table class="table" style="margin-top: 8px;">
                <thead>
                    <tr>
                        <th>æ ‡é¢˜</th>
                        <th>æ¥æº</th>
                        <th>å…³é”®è¯</th>
                        <th>æƒ…æ„Ÿ</th>
                    </tr>
                </thead>
                <tbody>
                    ${(result.articles_preview || []).slice(0, 10).map(a => `
                        <tr>
                            <td><a href="${a.url}" target="_blank" style="color: var(--accent);">${a.title.substring(0, 30)}...</a></td>
                            <td>${a.author}</td>
                            <td>${a.keyword}</td>
                            <td><span class="badge ${a.sentiment === 'ç§¯æ' ? 'badge-success' : a.sentiment === 'æ¶ˆæ' ? 'badge-danger' : 'badge-warning'}">${a.sentiment || 'æœªåˆ†æ'}</span></td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
}

// åŠ è½½å†å²ä»»åŠ¡
async function loadTasks() {
    try {
        const response = await fetch('/api/crawl/tasks');
        const tasks = await response.json();
        
        const container = document.getElementById('tasks-list');
        
        if (tasks.length === 0) {
            container.innerHTML = '<p style="color: var(--text-secondary);">æš‚æ— å†å²ä»»åŠ¡</p>';
            return;
        }
        
        container.innerHTML = tasks.map(task => `
            <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 8px;">
                <div>
                    <span class="badge ${task.status === 'completed' ? 'badge-success' : task.status === 'failed' ? 'badge-danger' : 'badge-warning'}">
                        ${task.status === 'completed' ? 'å·²å®Œæˆ' : task.status === 'failed' ? 'å¤±è´¥' : 'è¿›è¡Œä¸­'}
                    </span>
                    <span style="margin-left: 12px;">${task.task_id}</span>
                </div>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span style="color: var(--text-secondary); font-size: 13px;">
                        ${task.result ? task.result.total_articles + ' ç¯‡' : ''}
                    </span>
                    <span style="color: var(--text-secondary); font-size: 13px;">
                        ${new Date(task.created_at).toLocaleString()}
                    </span>
                </div>
            </div>
        `).join('');
        
    } catch (error) {
        console.error('åŠ è½½ä»»åŠ¡åˆ—è¡¨å¤±è´¥:', error);
    }
}

// ç”ŸæˆAIç®€æŠ¥
let currentBriefing = '';

async function generateAIBriefing() {
    const btn = document.getElementById('gen-briefing-btn');
    btn.disabled = true;
    btn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></div> ç”Ÿæˆä¸­...';
    
    try {
        const response = await fetch('/api/reports/briefing', {
            method: 'POST'
        });
        const data = await response.json();
        
        if (data.status === 'success') {
            currentBriefing = data.briefing;
            document.getElementById('briefing-content').textContent = data.briefing;
            document.getElementById('briefing-container').style.display = 'block';
            showAlert('AIç®€æŠ¥ç”ŸæˆæˆåŠŸï¼', 'success');
        } else if (data.status === 'warning') {
            showAlert(data.message, 'error');
        } else {
            showAlert('ç”Ÿæˆå¤±è´¥: ' + (data.detail || 'æœªçŸ¥é”™è¯¯'), 'error');
        }
        
    } catch (error) {
        showAlert('ç”Ÿæˆå¤±è´¥: ' + error.message, 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = 'ğŸ¤– ç”ŸæˆAIæ™ºèƒ½ç®€æŠ¥';
    }
}

async function sendToFeishu() {
    const btn = document.getElementById('send-feishu-btn');
    btn.disabled = true;
    btn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></div> å‘é€ä¸­...';
    
    try {
        const response = await fetch('/api/reports/send', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ report_content: currentBriefing || null })
        });
        const data = await response.json();
        
        if (data.status === 'success') {
            showAlert('æŠ¥å‘Šå·²å‘é€åˆ°é£ä¹¦ç¾¤ï¼', 'success');
        } else {
            showAlert('å‘é€å¤±è´¥: ' + (data.detail || data.message), 'error');
        }
        
    } catch (error) {
        showAlert('å‘é€å¤±è´¥: ' + error.message, 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = 'ğŸ“¤ å‘é€åˆ°é£ä¹¦';
    }
}

function copyBriefing() {
    if (!currentBriefing) {
        showAlert('æ²¡æœ‰å¯å¤åˆ¶çš„ç®€æŠ¥', 'error');
        return;
    }
    
    navigator.clipboard.writeText(currentBriefing).then(() => {
        showAlert('ç®€æŠ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
    }).catch(() => {
        showAlert('å¤åˆ¶å¤±è´¥', 'error');
    });
}

// é¡µé¢åŠ è½½
document.addEventListener('DOMContentLoaded', loadTasks);
</script>
{% endblock %}


