{% extends "base.html" %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">ç³»ç»Ÿé…ç½®</h1>
    <p class="page-subtitle">é…ç½®é£ä¹¦ã€LLMç­‰æœåŠ¡è¿æ¥</p>
</div>

<div id="alert-container"></div>

<!-- é£ä¹¦é…ç½® -->
<div class="card">
    <div class="card-title">ğŸ¦ é£ä¹¦é…ç½®</div>
    <form id="feishu-form">
        <div class="form-group">
            <label class="form-label">App ID</label>
            <input type="text" class="form-input" id="app_id" placeholder="cli_xxxxxx">
        </div>
        <div class="form-group">
            <label class="form-label">App Secret</label>
            <input type="password" class="form-input" id="app_secret" placeholder="xxxxxx">
        </div>
        <div class="form-group">
            <label class="form-label">å¤šç»´è¡¨æ ¼ App Token</label>
            <input type="text" class="form-input" id="bitable_app_token" placeholder="ä»è¡¨æ ¼URLè·å–">
        </div>
        <div class="form-group">
            <label class="form-label">æ•°æ®è¡¨ Table ID</label>
            <input type="text" class="form-input" id="bitable_table_id" placeholder="ä»è¡¨æ ¼URLè·å–">
        </div>
        <div class="form-group">
            <label class="form-label">Webhook URL (æœºå™¨äºº)</label>
            <input type="text" class="form-input" id="webhook_url" placeholder="https://open.feishu.cn/open-apis/bot/v2/hook/xxx">
        </div>
        <button type="submit" class="btn btn-primary">ä¿å­˜é£ä¹¦é…ç½®</button>
    </form>
</div>

<!-- LLMé…ç½® -->
<div class="card">
    <div class="card-title">ğŸ¤– LLMé…ç½®</div>
    <form id="llm-form">
        <div class="form-group">
            <label class="form-label">æœåŠ¡æä¾›å•†</label>
            <select class="form-input" id="llm_provider">
                <option value="siliconflow">ç¡…åŸºæµåŠ¨ (SiliconFlow)</option>
                <option value="openai">OpenAI</option>
                <option value="deepseek">DeepSeek</option>
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">æ¨¡å‹</label>
            <input type="text" class="form-input" id="llm_model" value="deepseek-ai/DeepSeek-V3">
        </div>
        <div class="form-group">
            <label class="form-label">API Key</label>
            <input type="password" class="form-input" id="llm_api_key" placeholder="sk-xxxxxx">
        </div>
        <div class="form-group">
            <label class="form-label">API Base URL</label>
            <input type="text" class="form-input" id="llm_base_url" value="https://api.siliconflow.cn/v1">
        </div>
        <button type="submit" class="btn btn-primary">ä¿å­˜LLMé…ç½®</button>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
function showAlert(message, type = 'success') {
    const container = document.getElementById('alert-container');
    container.innerHTML = `
        <div class="alert alert-${type}">
            ${message}
        </div>
    `;
    setTimeout(() => container.innerHTML = '', 3000);
}

// åŠ è½½é£ä¹¦é…ç½®
async function loadFeishuConfig() {
    try {
        const response = await fetch('/api/config/feishu');
        const data = await response.json();
        
        document.getElementById('app_id').value = data.app_id || '';
        document.getElementById('app_secret').value = data.app_secret || '';
        document.getElementById('bitable_app_token').value = data.bitable_app_token || '';
        document.getElementById('bitable_table_id').value = data.bitable_table_id || '';
        document.getElementById('webhook_url').value = data.webhook_url || '';
    } catch (error) {
        console.error('åŠ è½½é£ä¹¦é…ç½®å¤±è´¥:', error);
    }
}

// ä¿å­˜é£ä¹¦é…ç½®
document.getElementById('feishu-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const data = {
        app_id: document.getElementById('app_id').value,
        app_secret: document.getElementById('app_secret').value,
        bitable_app_token: document.getElementById('bitable_app_token').value,
        bitable_table_id: document.getElementById('bitable_table_id').value,
        webhook_url: document.getElementById('webhook_url').value,
    };
    
    try {
        const response = await fetch('/api/config/feishu', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            showAlert('é£ä¹¦é…ç½®ä¿å­˜æˆåŠŸï¼', 'success');
        } else {
            showAlert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
        }
    } catch (error) {
        showAlert('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
    }
});

// åŠ è½½LLMé…ç½®
async function loadLLMConfig() {
    try {
        const response = await fetch('/api/config/llm');
        const data = await response.json();
        
        document.getElementById('llm_provider').value = data.provider || 'siliconflow';
        document.getElementById('llm_model').value = data.model || '';
        document.getElementById('llm_api_key').value = data.api_key || '';
        document.getElementById('llm_base_url').value = data.base_url || '';
    } catch (error) {
        console.error('åŠ è½½LLMé…ç½®å¤±è´¥:', error);
    }
}

// ä¿å­˜LLMé…ç½®
document.getElementById('llm-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const data = {
        provider: document.getElementById('llm_provider').value,
        model: document.getElementById('llm_model').value,
        api_key: document.getElementById('llm_api_key').value,
        base_url: document.getElementById('llm_base_url').value,
    };
    
    try {
        const response = await fetch('/api/config/llm', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            showAlert('LLMé…ç½®ä¿å­˜æˆåŠŸï¼', 'success');
        } else {
            showAlert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
        }
    } catch (error) {
        showAlert('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
    }
});

// é¡µé¢åŠ è½½
document.addEventListener('DOMContentLoaded', function() {
    loadFeishuConfig();
    loadLLMConfig();
});
</script>
{% endblock %}




