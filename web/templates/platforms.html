{% extends "base.html" %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">å¹³å°ç®¡ç†</h1>
    <p class="page-subtitle">ç®¡ç†é‡‡é›†å¹³å°çš„ç™»å½•çŠ¶æ€å’Œé…ç½®</p>
</div>

<div id="alert-container"></div>

<!-- å°çº¢ä¹¦ -->
<div class="card">
    <div class="card-title">ğŸ“• å°çº¢ä¹¦</div>
    <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 16px;">
        <span id="xhs-status" class="badge badge-warning">æ£€æŸ¥ä¸­...</span>
        <span id="xhs-last-login" style="color: var(--text-secondary); font-size: 13px;"></span>
    </div>
    <div style="display: flex; gap: 12px;">
        <button class="btn btn-primary" onclick="startXHSLogin()" id="xhs-login-btn">
            ğŸ“± æ‰«ç ç™»å½•
        </button>
        <button class="btn btn-danger" onclick="xhsLogout()" id="xhs-logout-btn" style="display: none;">
            é€€å‡ºç™»å½•
        </button>
    </div>
    <div id="xhs-qrcode" style="margin-top: 16px; display: none;">
        <p style="color: var(--text-secondary); margin-bottom: 8px;">è¯·ä½¿ç”¨å°çº¢ä¹¦APPæ‰«æä¸‹æ–¹äºŒç»´ç ï¼š</p>
        <div style="background: white; padding: 16px; display: inline-block; border-radius: 8px;">
            <img id="xhs-qrcode-img" src="" alt="äºŒç»´ç " style="width: 200px; height: 200px;">
        </div>
    </div>
</div>

<!-- å¾®ä¿¡å…¬ä¼—å·å¹³å° -->
<div class="card">
    <div class="card-title">ğŸ’¬ å¾®ä¿¡å…¬ä¼—å·ï¼ˆé«˜çº§ï¼‰</div>
    <p style="color: var(--text-secondary); margin-bottom: 16px; font-size: 14px;">
        ç™»å½•å¾®ä¿¡å…¬ä¼—å·å¹³å°å¯è·å–å®æ—¶æ–‡ç« ï¼Œæ”¯æŒæŒ‰æ—¶é—´æ’åºã€‚
    </p>
    <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 16px;">
        <span id="wechat-status" class="badge badge-warning">æ£€æŸ¥ä¸­...</span>
        <span id="wechat-last-login" style="color: var(--text-secondary); font-size: 13px;"></span>
    </div>
    <div style="display: flex; gap: 12px;">
        <button class="btn btn-primary" onclick="startWechatLogin()" id="wechat-login-btn">
            ğŸ“± æ‰«ç ç™»å½•
        </button>
        <button class="btn btn-danger" onclick="wechatLogout()" id="wechat-logout-btn" style="display: none;">
            é€€å‡ºç™»å½•
        </button>
    </div>
</div>

<!-- å¹³å°é…ç½® -->
<div class="card">
    <div class="card-title">âš™ï¸ å¹³å°é…ç½®</div>
    <form id="platforms-form">
        <div class="form-group">
            <label class="form-label">å¾®ä¿¡å…¬ä¼—å·è·å–æ–¹å¼</label>
            <select class="form-input" id="wechat_method">
                <option value="sogou">æœç‹—å¾®ä¿¡æœç´¢ï¼ˆå…è´¹ï¼Œæœ‰å»¶è¿Ÿï¼‰</option>
                <option value="mp">å…¬ä¼—å·å¹³å°ï¼ˆéœ€ç™»å½•ï¼Œå®æ—¶ï¼‰</option>
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">
                <input type="checkbox" id="xhs_enabled" checked style="margin-right: 8px;">
                å¯ç”¨å°çº¢ä¹¦é‡‡é›†
            </label>
        </div>
        <div class="form-group">
            <label class="form-label">å°çº¢ä¹¦æ’åºæ–¹å¼</label>
            <select class="form-input" id="xhs_sort">
                <option value="time_descending">æœ€æ–°æ’åº</option>
                <option value="general">ç»¼åˆæ’åº</option>
                <option value="popularity_descending">æœ€çƒ­æ’åº</option>
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">æ—¶é—´è¿‡æ»¤ï¼ˆå°æ—¶ï¼‰</label>
            <input type="number" class="form-input" id="filter_hours" value="48" min="0">
            <small style="color: var(--text-secondary);">0è¡¨ç¤ºä¸é™åˆ¶ï¼Œ48è¡¨ç¤ºåªè·å–48å°æ—¶å†…çš„å†…å®¹</small>
        </div>
        <button type="submit" class="btn btn-primary">ä¿å­˜é…ç½®</button>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
let xhsSessionId = null;
let wechatSessionId = null;
let pollInterval = null;

function showAlert(message, type = 'success') {
    const container = document.getElementById('alert-container');
    container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
    setTimeout(() => container.innerHTML = '', 3000);
}

// æ£€æŸ¥å¹³å°çŠ¶æ€
async function checkPlatformsStatus() {
    try {
        // å°çº¢ä¹¦
        const xhsResp = await fetch('/api/auth/xhs/check');
        const xhsData = await xhsResp.json();
        
        const xhsStatus = document.getElementById('xhs-status');
        const xhsLoginBtn = document.getElementById('xhs-login-btn');
        const xhsLogoutBtn = document.getElementById('xhs-logout-btn');
        const xhsLastLogin = document.getElementById('xhs-last-login');
        
        if (xhsData.logged_in) {
            xhsStatus.textContent = 'å·²ç™»å½•';
            xhsStatus.className = 'badge badge-success';
            xhsLoginBtn.style.display = 'none';
            xhsLogoutBtn.style.display = 'inline-flex';
            if (xhsData.last_login) {
                xhsLastLogin.textContent = 'ä¸Šæ¬¡ç™»å½•: ' + new Date(xhsData.last_login).toLocaleString();
            }
        } else {
            xhsStatus.textContent = 'æœªç™»å½•';
            xhsStatus.className = 'badge badge-warning';
            xhsLoginBtn.style.display = 'inline-flex';
            xhsLogoutBtn.style.display = 'none';
        }
        
        // å¾®ä¿¡
        const wechatResp = await fetch('/api/auth/wechat/check');
        const wechatData = await wechatResp.json();
        
        const wechatStatus = document.getElementById('wechat-status');
        const wechatLoginBtn = document.getElementById('wechat-login-btn');
        const wechatLogoutBtn = document.getElementById('wechat-logout-btn');
        const wechatLastLogin = document.getElementById('wechat-last-login');
        
        if (wechatData.logged_in) {
            wechatStatus.textContent = 'å·²ç™»å½•';
            wechatStatus.className = 'badge badge-success';
            wechatLoginBtn.style.display = 'none';
            wechatLogoutBtn.style.display = 'inline-flex';
            if (wechatData.last_login) {
                wechatLastLogin.textContent = 'ä¸Šæ¬¡ç™»å½•: ' + new Date(wechatData.last_login).toLocaleString();
            }
        } else {
            wechatStatus.textContent = 'æœªç™»å½•';
            wechatStatus.className = 'badge badge-warning';
            wechatLoginBtn.style.display = 'inline-flex';
            wechatLogoutBtn.style.display = 'none';
        }
        
    } catch (error) {
        console.error('æ£€æŸ¥å¹³å°çŠ¶æ€å¤±è´¥:', error);
    }
}

// å°çº¢ä¹¦ç™»å½•
async function startXHSLogin() {
    try {
        const response = await fetch('/api/auth/xhs/login', {method: 'POST'});
        const data = await response.json();
        xhsSessionId = data.session_id;
        
        document.getElementById('xhs-status').textContent = 'ç­‰å¾…æ‰«ç ...';
        document.getElementById('xhs-status').className = 'badge badge-warning';
        document.getElementById('xhs-login-btn').disabled = true;
        
        // æ˜¾ç¤ºäºŒç»´ç åŒºåŸŸ
        document.getElementById('xhs-qrcode').style.display = 'block';
        
        // è½®è¯¢çŠ¶æ€
        pollInterval = setInterval(async () => {
            const statusResp = await fetch(`/api/auth/xhs/status/${xhsSessionId}`);
            const statusData = await statusResp.json();
            
            if (statusData.qrcode_url) {
                document.getElementById('xhs-qrcode-img').src = statusData.qrcode_url;
            }
            
            if (statusData.status === 'success') {
                clearInterval(pollInterval);
                showAlert('å°çº¢ä¹¦ç™»å½•æˆåŠŸï¼', 'success');
                document.getElementById('xhs-qrcode').style.display = 'none';
                checkPlatformsStatus();
            } else if (statusData.status === 'failed') {
                clearInterval(pollInterval);
                showAlert('ç™»å½•å¤±è´¥: ' + statusData.message, 'error');
                document.getElementById('xhs-qrcode').style.display = 'none';
                document.getElementById('xhs-login-btn').disabled = false;
            }
        }, 2000);
        
    } catch (error) {
        showAlert('å¯åŠ¨ç™»å½•å¤±è´¥: ' + error.message, 'error');
        document.getElementById('xhs-login-btn').disabled = false;
    }
}

async function xhsLogout() {
    if (!confirm('ç¡®å®šè¦é€€å‡ºå°çº¢ä¹¦ç™»å½•å—ï¼Ÿ')) return;
    
    try {
        await fetch('/api/auth/xhs/logout', {method: 'DELETE'});
        showAlert('å·²é€€å‡ºç™»å½•', 'success');
        checkPlatformsStatus();
    } catch (error) {
        showAlert('é€€å‡ºå¤±è´¥: ' + error.message, 'error');
    }
}

// å¾®ä¿¡ç™»å½•
async function startWechatLogin() {
    try {
        const response = await fetch('/api/auth/wechat/login', {method: 'POST'});
        const data = await response.json();
        wechatSessionId = data.session_id;
        
        document.getElementById('wechat-status').textContent = 'ç­‰å¾…æ‰«ç ...';
        document.getElementById('wechat-status').className = 'badge badge-warning';
        document.getElementById('wechat-login-btn').disabled = true;
        
        showAlert('è¯·åœ¨å¼¹å‡ºçš„æµè§ˆå™¨çª—å£ä¸­æ‰«ç ç™»å½•', 'success');
        
        // è½®è¯¢çŠ¶æ€
        pollInterval = setInterval(async () => {
            const statusResp = await fetch(`/api/auth/wechat/status/${wechatSessionId}`);
            const statusData = await statusResp.json();
            
            if (statusData.status === 'success') {
                clearInterval(pollInterval);
                showAlert('å¾®ä¿¡å…¬ä¼—å·å¹³å°ç™»å½•æˆåŠŸï¼', 'success');
                checkPlatformsStatus();
            } else if (statusData.status === 'failed') {
                clearInterval(pollInterval);
                showAlert('ç™»å½•å¤±è´¥: ' + statusData.message, 'error');
                document.getElementById('wechat-login-btn').disabled = false;
            }
        }, 2000);
        
    } catch (error) {
        showAlert('å¯åŠ¨ç™»å½•å¤±è´¥: ' + error.message, 'error');
        document.getElementById('wechat-login-btn').disabled = false;
    }
}

async function wechatLogout() {
    if (!confirm('ç¡®å®šè¦é€€å‡ºå¾®ä¿¡å…¬ä¼—å·å¹³å°ç™»å½•å—ï¼Ÿ')) return;
    
    try {
        await fetch('/api/auth/wechat/logout', {method: 'DELETE'});
        showAlert('å·²é€€å‡ºç™»å½•', 'success');
        checkPlatformsStatus();
    } catch (error) {
        showAlert('é€€å‡ºå¤±è´¥: ' + error.message, 'error');
    }
}

// åŠ è½½å¹³å°é…ç½®
async function loadPlatformsConfig() {
    try {
        const response = await fetch('/api/config/platforms');
        const data = await response.json();
        
        document.getElementById('wechat_method').value = data.wechat_method || 'sogou';
        document.getElementById('xhs_enabled').checked = data.xhs_enabled !== false;
        document.getElementById('xhs_sort').value = data.xhs_sort || 'time_descending';
        document.getElementById('filter_hours').value = data.filter_hours || 48;
    } catch (error) {
        console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
    }
}

// ä¿å­˜å¹³å°é…ç½®
document.getElementById('platforms-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const data = {
        wechat_method: document.getElementById('wechat_method').value,
        xhs_enabled: document.getElementById('xhs_enabled').checked,
        xhs_sort: document.getElementById('xhs_sort').value,
        filter_hours: parseInt(document.getElementById('filter_hours').value) || 48,
    };
    
    try {
        const response = await fetch('/api/config/platforms', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            showAlert('é…ç½®ä¿å­˜æˆåŠŸï¼', 'success');
        } else {
            showAlert('ä¿å­˜å¤±è´¥', 'error');
        }
    } catch (error) {
        showAlert('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
    }
});

// é¡µé¢åŠ è½½
document.addEventListener('DOMContentLoaded', function() {
    checkPlatformsStatus();
    loadPlatformsConfig();
});
</script>
{% endblock %}



