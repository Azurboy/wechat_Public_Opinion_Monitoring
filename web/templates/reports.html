{% extends "base.html" %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">æ•°æ®æ¦‚è§ˆ</h1>
    <p class="page-subtitle">æŸ¥çœ‹é‡‡é›†æ•°æ®ç»Ÿè®¡å’Œç”ŸæˆæŠ¥å‘Š</p>
</div>

<div id="alert-container"></div>

<!-- æ•°æ®çŠ¶æ€ -->
<div class="card" id="data-status-card">
    <div class="card-title">ğŸ“Š ä»Šæ—¥æ•°æ®æ¦‚è§ˆ</div>
    <div id="data-status">
        <div class="spinner"></div>
        <span style="margin-left: 12px; color: var(--text-secondary);">åŠ è½½ä¸­...</span>
    </div>
</div>

<!-- æ— æ•°æ®æç¤º -->
<div class="card" id="no-data-card" style="display: none;">
    <div style="text-align: center; padding: 32px;">
        <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“­</div>
        <h3 style="margin-bottom: 8px;">æš‚æ— é‡‡é›†æ•°æ®</h3>
        <p style="color: var(--text-secondary); margin-bottom: 24px;">è¯·å…ˆæ‰§è¡Œé‡‡é›†ä»»åŠ¡è·å–èˆ†æƒ…æ•°æ®</p>
        <a href="/tasks" class="btn btn-primary">å‰å¾€é‡‡é›†ä»»åŠ¡ â†’</a>
    </div>
</div>

<!-- æŠ¥å‘Šæ“ä½œ -->
<div class="card" id="report-actions-card" style="display: none;">
    <div class="card-title">ğŸ“ˆ ç”ŸæˆæŠ¥å‘Š</div>
    <div style="display: flex; gap: 12px; margin-bottom: 16px;">
        <button class="btn btn-primary" onclick="generateBriefing()" id="gen-btn">
            ğŸ¤– ç”ŸæˆAIæ™ºèƒ½ç®€æŠ¥
        </button>
        <button class="btn btn-secondary" onclick="sendToFeishu()" id="send-btn">
            ğŸ“¤ å‘é€åˆ°é£ä¹¦
        </button>
    </div>
</div>

<!-- ç®€æŠ¥å†…å®¹ -->
<div class="card" id="briefing-card" style="display: none;">
    <div class="card-title">ğŸ“‹ AIæ™ºèƒ½ç®€æŠ¥</div>
    <div id="briefing-content" style="white-space: pre-wrap; font-size: 14px; line-height: 1.8; padding: 16px; background: var(--bg-secondary); border-radius: 8px;">
    </div>
    <div style="margin-top: 16px;">
        <button class="btn btn-secondary" onclick="copyBriefing()">ğŸ“‹ å¤åˆ¶ç®€æŠ¥</button>
    </div>
</div>

<!-- æ–‡ç« åˆ—è¡¨ -->
<div class="card" id="articles-card" style="display: none;">
    <div class="card-title">ğŸ“° æ–‡ç« åˆ—è¡¨</div>
    <div id="articles-list"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentBriefing = '';
let reportData = null;

function showAlert(message, type = 'success') {
    const container = document.getElementById('alert-container');
    container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
    setTimeout(() => container.innerHTML = '', 5000);
}

async function loadReportData() {
    try {
        const response = await fetch('/api/reports/data');
        reportData = await response.json();
        
        const statusContainer = document.getElementById('data-status');
        
        if (!reportData.has_data) {
            // æ— æ•°æ®
            document.getElementById('data-status-card').style.display = 'none';
            document.getElementById('no-data-card').style.display = 'block';
            return;
        }
        
        // æ˜¾ç¤ºæ•°æ®æ¦‚è§ˆ
        const stats = reportData.stats;
        statusContainer.innerHTML = `
            <div class="stats-grid" style="margin-bottom: 0;">
                <div class="stat-card">
                    <div class="stat-value">${stats.total}</div>
                    <div class="stat-label">é‡‡é›†æ–‡ç« </div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" style="color: var(--success);">${stats.sentiment_stats?.['ç§¯æ'] || 0}</div>
                    <div class="stat-label">ç§¯æ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" style="color: var(--danger);">${stats.sentiment_stats?.['æ¶ˆæ'] || 0}</div>
                    <div class="stat-label">æ¶ˆæ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.sentiment_stats?.['ä¸­ç«‹'] || 0}</div>
                    <div class="stat-label">ä¸­ç«‹</div>
                </div>
            </div>
            ${stats.crawled_at ? `<p style="margin-top: 16px; color: var(--text-secondary); font-size: 13px;">æ•°æ®é‡‡é›†æ—¶é—´ï¼š${new Date(stats.crawled_at).toLocaleString('zh-CN')}</p>` : ''}
        `;
        
        // æ˜¾ç¤ºæ“ä½œæŒ‰é’®
        document.getElementById('report-actions-card').style.display = 'block';
        
        // æ˜¾ç¤ºæ–‡ç« åˆ—è¡¨
        if (reportData.articles && reportData.articles.length > 0) {
            document.getElementById('articles-card').style.display = 'block';
            document.getElementById('articles-list').innerHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>æ ‡é¢˜</th>
                            <th>æ¥æº</th>
                            <th>å…³é”®è¯</th>
                            <th>æƒ…æ„Ÿ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${reportData.articles.map(a => `
                            <tr>
                                <td><a href="${a.url}" target="_blank" style="color: var(--accent);">${(a.title || '').substring(0, 40)}${a.title && a.title.length > 40 ? '...' : ''}</a></td>
                                <td>${a.author || '-'}</td>
                                <td>${a.keyword || '-'}</td>
                                <td><span class="badge ${a.sentiment === 'ç§¯æ' ? 'badge-success' : a.sentiment === 'æ¶ˆæ' ? 'badge-danger' : 'badge-warning'}">${a.sentiment || 'æœªåˆ†æ'}</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
    } catch (error) {
        console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
        document.getElementById('data-status').innerHTML = `
            <p style="color: var(--danger);">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</p>
        `;
    }
}

async function generateBriefing() {
    const btn = document.getElementById('gen-btn');
    btn.disabled = true;
    btn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></div> ç”Ÿæˆä¸­...';
    
    try {
        const response = await fetch('/api/reports/briefing', { method: 'POST' });
        const data = await response.json();
        
        if (data.status === 'success') {
            currentBriefing = data.briefing;
            document.getElementById('briefing-content').textContent = data.briefing;
            document.getElementById('briefing-card').style.display = 'block';
            showAlert('AIç®€æŠ¥ç”ŸæˆæˆåŠŸï¼', 'success');
        } else {
            showAlert(data.message || 'ç”Ÿæˆå¤±è´¥', 'error');
        }
        
    } catch (error) {
        showAlert('ç”Ÿæˆå¤±è´¥: ' + error.message, 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = 'ğŸ¤– ç”ŸæˆAIæ™ºèƒ½ç®€æŠ¥';
    }
}

async function sendToFeishu() {
    const btn = document.getElementById('send-btn');
    btn.disabled = true;
    btn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></div> å‘é€ä¸­...';
    
    try {
        const response = await fetch('/api/reports/send', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ report_content: currentBriefing || null })
        });
        const data = await response.json();
        
        if (data.status === 'success') {
            showAlert('æŠ¥å‘Šå·²å‘é€åˆ°é£ä¹¦ç¾¤ï¼', 'success');
        } else {
            showAlert('å‘é€å¤±è´¥: ' + (data.detail || data.message), 'error');
        }
        
    } catch (error) {
        showAlert('å‘é€å¤±è´¥: ' + error.message, 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = 'ğŸ“¤ å‘é€åˆ°é£ä¹¦';
    }
}

function copyBriefing() {
    if (!currentBriefing) {
        showAlert('æ²¡æœ‰å¯å¤åˆ¶çš„ç®€æŠ¥', 'error');
        return;
    }
    
    navigator.clipboard.writeText(currentBriefing).then(() => {
        showAlert('ç®€æŠ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
    }).catch(() => {
        showAlert('å¤åˆ¶å¤±è´¥', 'error');
    });
}

// é¡µé¢åŠ è½½
document.addEventListener('DOMContentLoaded', loadReportData);
</script>
{% endblock %}
