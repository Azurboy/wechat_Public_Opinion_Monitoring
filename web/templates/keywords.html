{% extends "base.html" %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">å…³é”®è¯ç®¡ç†</h1>
    <p class="page-subtitle">é…ç½®ç›‘æµ‹å…³é”®è¯å’Œè¿‡æ»¤è§„åˆ™</p>
</div>

<div id="alert-container"></div>

<!-- æ·»åŠ å…³é”®è¯ -->
<div class="card">
    <div class="card-title">â• æ·»åŠ å…³é”®è¯</div>
    <form id="add-keyword-form" style="display: flex; gap: 12px;">
        <input type="text" class="form-input" id="new-keyword" placeholder="è¾“å…¥å…³é”®è¯" style="flex: 1;">
        <button type="submit" class="btn btn-primary">æ·»åŠ </button>
    </form>
</div>

<!-- å…³é”®è¯åˆ—è¡¨ -->
<div class="card">
    <div class="card-title">ğŸ”‘ å½“å‰å…³é”®è¯</div>
    <div id="keywords-list">
        <div class="spinner"></div>
    </div>
</div>

<!-- è¿‡æ»¤è§„åˆ™ -->
<div class="card">
    <div class="card-title">ğŸ” è¿‡æ»¤è§„åˆ™</div>
    <p style="color: var(--text-secondary); margin-bottom: 16px; font-size: 14px;">
        è®¾ç½®å…³é”®è¯è¿‡æ»¤è§„åˆ™ï¼Œä¾‹å¦‚"Monolith"å¿…é¡»åŒæ—¶åŒ…å«"ç ºæ€èµ„æœ¬"ã€"æŠ•èµ„"ç­‰è¯æ‰ä¿ç•™ã€‚
    </p>
    <div id="filter-rules">
        <div class="spinner"></div>
    </div>
</div>

<!-- é‡‡é›†è®¾ç½® -->
<div class="card">
    <div class="card-title">âš™ï¸ é‡‡é›†è®¾ç½®</div>
    <form id="search-config-form">
        <div class="form-group">
            <label class="form-label">æ¯ä¸ªå…³é”®è¯æœç´¢é¡µæ•°</label>
            <input type="number" class="form-input" id="max_pages" value="3" min="1" max="10">
        </div>
        <div class="form-group">
            <label class="form-label">è¯·æ±‚é—´éš”ï¼ˆç§’ï¼‰</label>
            <input type="number" class="form-input" id="request_delay" value="3" min="1" max="10">
        </div>
        <button type="submit" class="btn btn-primary">ä¿å­˜è®¾ç½®</button>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
let keywordsData = { keywords: [], relevance_keywords: {} };

function showAlert(message, type = 'success') {
    const container = document.getElementById('alert-container');
    container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
    setTimeout(() => container.innerHTML = '', 3000);
}

// åŠ è½½å…³é”®è¯é…ç½®
async function loadKeywordsConfig() {
    try {
        const response = await fetch('/api/config/keywords');
        keywordsData = await response.json();
        
        renderKeywords();
        renderFilterRules();
        
        document.getElementById('max_pages').value = keywordsData.max_pages || 3;
        document.getElementById('request_delay').value = keywordsData.request_delay || 3;
        
    } catch (error) {
        console.error('åŠ è½½å…³é”®è¯å¤±è´¥:', error);
    }
}

// æ¸²æŸ“å…³é”®è¯åˆ—è¡¨
function renderKeywords() {
    const container = document.getElementById('keywords-list');
    
    if (!keywordsData.keywords || keywordsData.keywords.length === 0) {
        container.innerHTML = '<p style="color: var(--text-secondary);">æš‚æ— å…³é”®è¯ï¼Œè¯·æ·»åŠ </p>';
        return;
    }
    
    container.innerHTML = keywordsData.keywords.map(kw => `
        <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 8px;">
            <span>${kw}</span>
            <button class="btn btn-danger" style="padding: 6px 12px; font-size: 12px;" onclick="deleteKeyword('${kw}')">
                åˆ é™¤
            </button>
        </div>
    `).join('');
}

// æ¸²æŸ“è¿‡æ»¤è§„åˆ™
function renderFilterRules() {
    const container = document.getElementById('filter-rules');
    const rules = keywordsData.relevance_keywords || {};
    
    if (Object.keys(rules).length === 0) {
        container.innerHTML = '<p style="color: var(--text-secondary);">æš‚æ— è¿‡æ»¤è§„åˆ™</p>';
        return;
    }
    
    container.innerHTML = Object.entries(rules).map(([keyword, words]) => `
        <div style="margin-bottom: 16px; padding: 16px; background: var(--bg-secondary); border-radius: 8px;">
            <div style="font-weight: 600; margin-bottom: 8px;">${keyword}</div>
            <div style="color: var(--text-secondary); font-size: 13px;">
                å¿…é¡»åŒ…å«: ${words.join('ã€')}
            </div>
        </div>
    `).join('');
}

// æ·»åŠ å…³é”®è¯
document.getElementById('add-keyword-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const keyword = document.getElementById('new-keyword').value.trim();
    if (!keyword) return;
    
    try {
        const response = await fetch(`/api/config/keywords/add?keyword=${encodeURIComponent(keyword)}`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            showAlert(`å…³é”®è¯ "${keyword}" å·²æ·»åŠ `, 'success');
            document.getElementById('new-keyword').value = '';
            loadKeywordsConfig();
        } else {
            showAlert(data.message, 'error');
        }
    } catch (error) {
        showAlert('æ·»åŠ å¤±è´¥: ' + error.message, 'error');
    }
});

// åˆ é™¤å…³é”®è¯
async function deleteKeyword(keyword) {
    if (!confirm(`ç¡®å®šè¦åˆ é™¤å…³é”®è¯ "${keyword}" å—ï¼Ÿ`)) return;
    
    try {
        const response = await fetch(`/api/config/keywords/${encodeURIComponent(keyword)}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            showAlert(`å…³é”®è¯ "${keyword}" å·²åˆ é™¤`, 'success');
            loadKeywordsConfig();
        } else {
            showAlert('åˆ é™¤å¤±è´¥', 'error');
        }
    } catch (error) {
        showAlert('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
    }
}

// ä¿å­˜é‡‡é›†è®¾ç½®
document.getElementById('search-config-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    keywordsData.max_pages = parseInt(document.getElementById('max_pages').value) || 3;
    keywordsData.request_delay = parseInt(document.getElementById('request_delay').value) || 3;
    
    try {
        const response = await fetch('/api/config/keywords', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(keywordsData)
        });
        
        if (response.ok) {
            showAlert('è®¾ç½®å·²ä¿å­˜', 'success');
        } else {
            showAlert('ä¿å­˜å¤±è´¥', 'error');
        }
    } catch (error) {
        showAlert('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
    }
});

// é¡µé¢åŠ è½½
document.addEventListener('DOMContentLoaded', loadKeywordsConfig);
</script>
{% endblock %}



